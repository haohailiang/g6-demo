const contactsGraphData = {
    "entities": [
        {
            "backColor": "#3A9CAA",
            "icon": -1,
            "typeName": "员工",
            "titleProp": [
                {
                    "dataType": "string",
                    "en": "StaffIDGONGNumHUOMailbox",
                    "cn": "员工ID-工号或邮箱",
                    "value": "ID5314624",
                    "multi": false
                }
            ],
            "label": "Staff",
            "groupProp": [
                {
                    "dataType": "string",
                    "en": "StaffIDGONGNumHUOMailbox",
                    "cn": "员工ID-工号或邮箱",
                    "value": "ID5314624",
                    "multi": false
                }
            ],
            "id": "4096168008",
            "labelName": "员工",
            "type": "Staff",
            "key": "ID5314624_Staff"
        },
        {
            "backColor": "#3A9CAA",
            "icon": -1,
            "typeName": "客户个人",
            "titleProp": [
                {
                    "dataType": "string",
                    "en": "wxid",
                    "cn": "微信id",
                    "value": "13811154957",
                    "multi": false
                }
            ],
            "label": "ClientPersonal",
            "groupProp": [
                {
                    "dataType": "string",
                    "en": "wxid",
                    "cn": "微信id",
                    "value": "13811154957",
                    "multi": false
                }
            ],
            "id": "4096155688",
            "labelName": "客户个人",
            "type": "ClientPersonal",
            "key": "13811154957_ClientPersonal"
        }
    ],
    "relations": [
        {
            // "isVirtualRelation": true,
            "isVirtualRelation": false,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "标签平台数据分析",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "易动力",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "时空盒数字",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "盟新",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "富罳",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "黄石金承",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "华成育卓",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "华泰通安",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "惠派国际公司",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "济南亿次元",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "快讯",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "网新恒天",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "图龙信息",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "和泰",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "联软",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "商软冠联",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        },
        {
            "isVirtualRelation": true,
            "titleProp": [],
            "label": "Project",
            "subjectId": "4096155688",
            "graphName": "scopa",
            "objectKey": "ID5314624_Staff",
            "id": "3rhjuv4-cn4-9frp-9ns",
            "groupProp": [],
            "projectName": "scopa",
            "labelName": "趋势",
            "subjectKey": "13811154957_ClientPersonal",
            "key": "Project::13811154957_ClientPersonal::ID5314624_Staff",
            "objectId": "4096168008"
        }
    ]
}

const subjectBgColor = '#d8d8d8'
const subjectBorderColor = '#fd960c'
const subjectLabelColor = '#000000'
const objectColor = '#ffffff'
const objectBgColor = '#86889d'

/**
 * 格式化内部联系人图谱信息
 * @param contactsGraphData 原始的图谱信息
 */
function getFormatContactsGraphData(contactsGraphData) {
    const { entities = [], relations = [] } = contactsGraphData

    if (relations.length === 0) {
        return { nodes: [], edges: [] }
    }

    // combos
    const combos = Array.from(
        new Set(relations.filter(item => item.isVirtualRelation).map(item => item.labelName))
    ).map(item => ({ id: item, label: item }))

    // 主体
    const { subjectId } = relations[0]
    const subjectEntity = entities.find(item => item.id === subjectId)
    const subjectNode = {
        id: subjectEntity.id,
        nodeType: 'subject',
        label: subjectEntity.titleProp[0].value,
        type: 'circle',
        size: [60],
        style: {
            fill: subjectBgColor,
            stroke: subjectBorderColor,
            lineWidth: 3,
        },
        labelCfg: {
            style: {
                fill: subjectLabelColor,
                fontSize: 24,
            },
            position: 'bottom',
        },
        icon: {
            show: subjectEntity.icon !== -1,
            img: subjectEntity.icon,
            width: 56,
            height: 56
        }
    }

    // edges
    const comboEdges = combos.map(comboItem => ({
        id: `${subjectEntity.id}-${comboItem.id}`,
        source: subjectEntity.id,
        target: comboItem.id,
    }))

    const realEdges = relations.filter(item => !item.isVirtualRelation)
        .map(readEdge => ({
            id: `${subjectEntity.id}-${readEdge.objectId}`,
            source: subjectEntity.id,
            target: readEdge.objectId,
            label: readEdge.labelName,
            fontSize: 14,
        }))

    // 客体
    const objectNodes = []
    let soleNodes = []

    entities
        .filter(item => item.id !== subjectId)
        .forEach(objectItem => {
            const joinCollection = relations
                .filter(item => item.isVirtualRelation)
                .filter(item => item.subjectId === subjectEntity.id && item.objectId === objectItem.id) ?? []
            const soleCollection = relations
                .filter(item => !item.isVirtualRelation)
                .filter(item => item.subjectId === subjectEntity.id && item.objectId === objectItem.id) ?? []

            const baseObjectNode = {
                // id: objectItem.id,
                nodeType: 'object',
                label: objectItem.labelName,
                type: 'circle',
                // comboId: '关注目标',
                size: 8,
                style: {
                    fill: objectBgColor,
                    lineWidth: 0
                },
                labelCfg: {
                    refY: 10,
                    position: 'bottom',
                    style: {
                        fontSize: 12,
                        fill: '#111111',
                        opacity: 0.65,
                    },
                },
                icon: {
                    show: false,
                    img: subjectEntity.icon,
                }
            }

            joinCollection.forEach(joinItem => {
                const { labelName: groupName } = joinItem
                const tempId = `${groupName}-${joinItem.objectId}`
                const objectName = entities.find(item => item.id === joinItem.objectId).titleProp[0].value

                objectNodes.push({
                    ...baseObjectNode, id: tempId, comboId: groupName, label: objectName
                })
            })

            soleCollection.forEach(soleItem => {
                const tempId = `${soleItem.objectId}`
                objectNodes.push({
                    ...baseObjectNode, id: tempId, label: soleItem.label, size: 30,
                })
            })

            soleNodes = soleCollection.map(item => item.objectId)
        })

    // 同类客体节点数统计
    const objectNodesStat = objectNodes.reduce((total, curNode) => {
        const { comboId } = curNode

        if (comboId) {
            const prevNum = total[comboId] || 0
            return { ...total, [comboId]: prevNum + 1 }
        }

        return total
    }, {})
    const statNodes = Object.keys(objectNodesStat).map((curComboId, curComboIndex) => {
        const label = objectNodesStat[curComboId] > 99 ? '99+' : String(objectNodesStat[curComboId])
        return {
            id: `${curComboId}-stat-${curComboIndex}`,
            nodeType: 'stat',
            label,
            type: 'circle',
            size: 32,
            style: {
                fill: objectBgColor,
                lineWidth: 0
            },
            labelCfg: {
                style: {
                    fontSize: 12,
                    fill: objectColor,
                }
            },
            icon: {
                show: false,
            },
            comboId: curComboId,
        }
    })

    const nodes = [subjectNode, ...objectNodes, ...statNodes]

    return { nodes, combos, edges: [...comboEdges, ...realEdges], soleNodes, }
}

const data = getFormatContactsGraphData(contactsGraphData)