<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自定义树图中的边</title>
    <style>
        #container {
            width: calc(100vw - 50px);
            height: calc(100vh - 50px);
        }
    </style>
    <script src="../../../lib/g6-4.0.3.min.js"></script>
    <!-- <script src="../../00-mock/data-1.js"></script> -->
</head>

<body>
    <!-- 1. 创建容器 -->
    <div id="container"></div>
    <script>
        // 减号
        // const COLLAPSE_ICON = function COLLAPSE_ICON(x, y, r) {
        //     return [
        //         ['M', x - r, y - r],
        //         // 弧线画法参考附件
        //         ['a', r, r, 0, 1, 0, r * 2, 0],
        //         ['a', r, r, 0, 1, 0, -r * 2, 0],
        //         ['M', x + 2 - r, y - r],
        //         ['L', x + r - 2, y - r],
        //     ];
        // };

        // 关闭符号
        const COLLAPSE_ICON = function COLLAPSE_ICON(x, y, r) {
            return [
                ['M', x - r, y - r],
                // 弧线画法参考附件
                ['a', r, r, 0, 1, 0, r * 2, 0],
                ['a', r, r, 0, 1, 0, -r * 2, 0],
                // ['M', x + 2 - r, y - r],
                ['M', x - (r - 2) * Math.cos(Math.PI / 4), y - (r - 2) * Math.sin(Math.PI / 4) - r],
                ['L', x + (r - 2) * Math.cos(Math.PI / 4), y + (r - 2) * Math.sin(Math.PI / 4) - r],
                ['M', x + (r - 2) * Math.cos(Math.PI / 4), y - (r - 2) * Math.sin(Math.PI / 4) - r],
                ['L', x - (r - 2) * Math.cos(Math.PI / 4), y + (r - 2) * Math.sin(Math.PI / 4) - r],
            ];
        };
        // 加号
        const EXPAND_ICON = function EXPAND_ICON(x, y, r) {
            return [
                ['M', x - r, y - r],
                ['a', r, r, 0, 1, 0, r * 2, 0],
                ['a', r, r, 0, 1, 0, -r * 2, 0],
                ['M', x + 2 - r, y - r],
                ['L', x + r - 2, y - r],
                ['M', x, y - 2 * r + 2],
                ['L', x, y - 2],
            ];
        };

        const data = {
            id: 'root',
            label: 'root',
            children: [
                {
                    id: 'c1',
                    label: 'c1',
                    children: [
                        {
                            id: 'c1-1',
                            label: 'c1-1',
                        },
                        {
                            id: 'c1-2',
                            label: 'c1-2',
                            children: [
                                {
                                    id: 'c1-2-1',
                                    label: 'c1-2-1',
                                },
                                {
                                    id: 'c1-2-2',
                                    label: 'c1-2-2',
                                },
                            ],
                        },
                    ],
                },
                {
                    id: 'c2',
                    label: 'c2',
                },
                {
                    id: 'c3',
                    label: 'c3',
                    children: [
                        {
                            id: 'c3-1',
                            label: 'c3-1',
                        },
                        {
                            id: 'c3-2',
                            label: 'c3-2',
                            children: [
                                {
                                    id: 'c3-2-1',
                                    label: 'c3-2-1',
                                },
                                {
                                    id: 'c3-2-2',
                                    label: 'c3-2-2',
                                },
                                {
                                    id: 'c3-2-3',
                                    label: 'c3-2-3',
                                },
                            ],
                        },
                        {
                            id: 'c3-3',
                            label: 'c3-3',
                        },
                    ],
                },
            ],
        };

        G6.Util.traverseTree(data, (d) => {
            d.leftIcon = {
                style: {
                    fill: '#e6fffb',
                    stroke: '#e6fffb',
                },
                img: 'https://gw.alipayobjects.com/mdn/rms_f8c6a0/afts/img/A*Q_FQT6nwEC8AAAAAAAAAAABkARQnAQ',
            };
            return true;
        });

        G6.registerNode(
            'icon-node',
            {
                // 这个选项参数会和defaultNode的参数进行合并,defaultNode优先级比这个高
                options: {
                    size: [60, 20],
                    stroke: '#ff0000',
                    fill: '#ff0000',
                },
                draw(cfg, group) {
                    const styles = this.getShapeStyle(cfg);
                    console.log('%c styles===', 'color:#fff;background: red;', styles)
                    const { labelCfg = {} } = cfg;

                    const w = styles.width;
                    const h = styles.height;

                    // 继承默认宽高, 以图形中心为原点
                    const keyShape = group.addShape('rect', {
                        attrs: {
                            ...styles,
                            x: -w / 2,
                            y: -h / 2,
                        },
                    });

                    /**
                     * leftIcon 格式如下：
                     *  {
                     *    style: ShapeStyle;
                     *    img: ''
                     *  }
                     */
                    // console.log('cfg.leftIcon', cfg.leftIcon);
                    if (cfg.leftIcon) {
                        const { style, img } = cfg.leftIcon;
                        group.addShape('rect', {
                            attrs: {
                                x: 1 - w / 2,
                                y: 1 - h / 2,
                                width: 38,
                                height: styles.height - 2,
                                fill: '#8c8c8c',
                                ...style,
                            },
                        });

                        group.addShape('image', {
                            attrs: {
                                x: 8 - w / 2,
                                y: 8 - h / 2,
                                width: 24,
                                height: 24,
                                img:
                                    img ||
                                    'https://g.alicdn.com/cm-design/arms-trace/1.0.155/styles/armsTrace/images/TAIR.png',
                            },
                            name: 'image-shape',
                        });
                    }

                    // 如果不需要动态增加或删除元素，则不需要 add 这两个 marker
                    group.addShape('marker', {
                        attrs: {
                            x: 40 - w / 2,
                            y: 52 - h / 2,
                            r: 6,
                            stroke: '#73d13d',
                            cursor: 'pointer',
                            symbol: EXPAND_ICON,
                        },
                        name: 'add-item',
                    });

                    group.addShape('marker', {
                        attrs: {
                            x: 80 - w / 2,
                            y: 52 - h / 2,
                            r: 6,
                            stroke: '#fff',
                            fill: '#f00',
                            cursor: 'pointer',
                            symbol: COLLAPSE_ICON,
                        },
                        name: 'remove-item',
                    });

                    if (cfg.label) {
                        group.addShape('text', {
                            attrs: {
                                ...labelCfg.style,
                                text: cfg.label,
                                x: 50 - w / 2,
                                y: 25 - h / 2,
                            },
                        });
                    }

                    return keyShape;
                },
                update: undefined
            },
            'rect',
        );

        G6.registerEdge('flow-line', {
            draw(cfg, group) {
                const startPoint = cfg.startPoint;
                const endPoint = cfg.endPoint;

                const { style } = cfg;
                const shape = group.addShape('path', {
                    attrs: {
                        stroke: style.stroke,
                        endArrow: style.endArrow,
                        path: [
                            ['M', startPoint.x, startPoint.y],
                            ['L', startPoint.x, (startPoint.y + endPoint.y) / 2],
                            ['L', endPoint.x, (startPoint.y + endPoint.y) / 2],
                            ['L', endPoint.x, endPoint.y],
                        ],
                    },
                });

                return shape;
            },
        });

        const defaultStateStyles = {
            hover: {
                stroke: '#1890ff',
                lineWidth: 4,
            },
        };

        const defaultNodeStyle = {
            fill: '#91d5ff',
            stroke: '#40a9ff',
            radius: 5,
        };

        const defaultEdgeStyle = {
            stroke: '#91d5ff',
            endArrow: {
                path: 'M 0,0 L 12, 6 L 9,0 L 12, -6 Z',
                fill: '#91d5ff',
                d: -20,
            },
        };

        const defaultLayout = {
            type: 'compactBox',
            direction: 'TB',
            getId: function getId(d) {
                return d.id;
            },
            getHeight: function getHeight() {
                return 16;
            },
            getWidth: function getWidth() {
                return 16;
            },
            getVGap: function getVGap() {
                return 40;
            },
            getHGap: function getHGap() {
                return 70;
            },
        };

        const defaultLabelCfg = {
            style: {
                fill: '#000',
                fontSize: 12,
            },
        };

        const width = document.getElementById('container').scrollWidth;
        const height = document.getElementById('container').scrollHeight || 500;

        const minimap = new G6.Minimap({
            size: [150, 100],
        });
        const graph = new G6.TreeGraph({
            container: 'container',
            width,
            height,
            linkCenter: true,
            plugins: [minimap],
            modes: {
                default: ['drag-canvas', 'zoom-canvas'],
            },
            defaultNode: {
                type: 'icon-node',
                size: [120, 40],
                style: defaultNodeStyle,
                labelCfg: defaultLabelCfg,
            },
            defaultEdge: {
                type: 'flow-line',
                style: defaultEdgeStyle,
            },
            nodeStateStyles: defaultStateStyles,
            edgeStateStyles: defaultStateStyles,
            layout: defaultLayout,
        });

        graph.data(data);
        graph.render();
        graph.fitView();

        graph.on('node:mouseenter', (evt) => {
            const { item } = evt;
            graph.setItemState(item, 'hover', true);
        });

        graph.on('node:mouseleave', (evt) => {
            const { item } = evt;
            graph.setItemState(item, 'hover', false);
        });

        graph.on('node:click', (evt) => {
            const { item, target } = evt;
            const targetType = target.get('type');
            const name = target.get('name');

            // 增加元素
            if (targetType === 'marker') {
                const model = item.getModel();
                if (name === 'add-item') {
                    if (!model.children) {
                        model.children = [];
                    }
                    const id = `n-${Math.random()}`;
                    model.children.push({
                        id,
                        label: id.substr(0, 8),
                        leftIcon: {
                            style: {
                                fill: '#e6fffb',
                                stroke: '#e6fffb',
                            },
                            img:
                                'https://gw.alipayobjects.com/mdn/rms_f8c6a0/afts/img/A*Q_FQT6nwEC8AAAAAAAAAAABkARQnAQ',
                        },
                    });
                    // 看这个能不能借鉴下
                    // https://g6.antv.vision/zh/docs/api/TreeGraph/#updatechilddata-parent
                    graph.updateChild(model, model.id);
                } else if (name === 'remove-item') {
                    graph.removeChild(model.id);
                }
            }
        });
    </script>
</body>

</html>